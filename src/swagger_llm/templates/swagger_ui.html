<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="{{ swagger_css_url }}" />
    <link rel="stylesheet" type="text/css" href="{{ theme_css_url }}" />
    <!-- FOUC fix: Apply default theme immediately before page renders -->
    <script>
      (function() {
        try {
          var themeData = JSON.parse(localStorage.getItem('swagger-llm-theme') || '{"theme":"dark","customColors":{}}');
          var colors = {
            dark: { primary: '#1d4ed8', background: '#0f172a', textPrimary: '#f7fafc', secondary: '#2d3748', panelBg: '#1f2937', headerBg: '#111827', borderColor: '#4a5568', textSecondary: '#cbd5e0', inputBg: '#1f2937', accent: '#718096', primaryHover: '#1e40af' },
            light: { primary: '#2563eb', background: '#f7fafc', textPrimary: '#1a202c', secondary: '#e2e8f0', panelBg: '#ffffff', headerBg: '#edf2f7', borderColor: '#cbd5e0', textSecondary: '#4a5568', inputBg: '#f7fafc', accent: '#718096', primaryHover: '#1d4ed8' }
          };
          var theme = colors[themeData.theme] || colors.dark;
          var merged = Object.assign({}, theme, themeData.customColors || {});
          var css = ':root { --theme-primary: ' + merged.primary + '; --theme-primary-hover: ' + (merged.primaryHover || merged.primary) + '; --theme-background: ' + merged.background + '; --theme-text-primary: ' + merged.textPrimary + '; --theme-secondary: ' + merged.secondary + '; --theme-panel-bg: ' + (merged.panelBg || merged.secondary) + '; --theme-header-bg: ' + (merged.headerBg || merged.background) + '; --theme-border-color: ' + (merged.borderColor || merged.secondary) + '; --theme-text-secondary: ' + (merged.textSecondary || '#6b7280') + '; --theme-input-bg: ' + (merged.inputBg || merged.secondary) + '; --theme-accent: ' + merged.accent + '; }';
          var style = document.createElement('style');
          style.id = 'swagger-llm-theme-styles';
          style.textContent = css;
          document.head.appendChild(style);
        } catch(e) {}
      })();
    </script>
  </head>
  <body>
    <div id="swagger-ui"></div>

    <script src="{{ swagger_js_url }}"></script>
    <script src="{{ llm_settings_js_url }}"></script>
    <script src="{{ llm_layout_js_url }}"></script>

    <style>
      /* LLM Panel CSS - scoped to avoid conflicts */
      #llm-settings-panel {
        font-family: 'Inter', 'Segoe UI', sans-serif;
      }
      .llm-provider-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-right: 8px;
        color: #fff;
      }
      .llm-provider-openai { background-color: #10a37f; }
      .llm-provider-anthropic { background-color: #d97757; }
      .llm-provider-ollama { background-color: #2b90d8; }
      .llm-provider-lmstudio { background-color: #6366f1; }
      .llm-provider-vllm { background-color: #facc15; color: #1a1a1a; }
      .llm-provider-azure { background-color: #0078d4; }
    </style>

    <script>
      // Read LLM settings from localStorage (set by the LLMSettingsPanel)
      var STORAGE_KEY = "swagger-llm-settings";

      function getLLMSettings() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch (e) {
          return {};
        }
      }

      // Cache for LLM header paths (loaded on demand)
      var _llmHeaderPathsCache = null;

      // Fetch LLM header paths from backend
      function fetchLLMHeaderPaths() {
        if (_llmHeaderPathsCache !== null) {
          return Promise.resolve(_llmHeaderPathsCache);
        }
        return fetch('/swagger-llm/llm-header-paths')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            _llmHeaderPathsCache = data.paths || [];
            return _llmHeaderPathsCache;
          })
          .catch(function(err) {
            console.warn('Failed to fetch LLM header paths:', err);
            _llmHeaderPathsCache = [];
            return [];
          });
      }

      // Check if an endpoint path requires X-LLM-* headers
      function endpointNeedsLLMHeaders(path) {
        if (_llmHeaderPathsCache === null) return false;
        // Check if any path in the list matches or is a prefix
        return _llmHeaderPathsCache.some(function(p) {
          // Handle path matching - exact match or prefix with parameter
          if (p === path) return true;
          // For paths like /chat/completions vs /swagger-llm/llm-header-paths
          // Simple prefix matching for this use case
          return path === p;
        });
      }

      window.onload = function () {
        // Fetch LLM header paths before initializing Swagger UI
        fetchLLMHeaderPaths().then(function() {
          var ui = SwaggerUIBundle({
            url: "{{ openapi_url }}",
            dom_id: "#swagger-ui",
            presets: [SwaggerUIBundle.presets.apis, SwaggerUIBundle.SwaggerUIStandalonePreset],
            plugins: [
              SwaggerUIBundle.plugins.DownloadUrl,
              LLMSettingsPlugin,
              LLMLayoutPlugin,
            ],
            layout: "LLMDocsLayout",

            // Inject X-LLM-* headers only for endpoints that declare them
            requestInterceptor: function (request) {
              // Extract path from URL (handle absolute and relative URLs)
              var url = request.url || '';
              var path = url;
              
              // Remove origin if present (absolute URL)
              try {
                var urlObj = new URL(url, window.location.origin);
                path = urlObj.pathname;
              } catch (e) {
                // If URL parsing fails, use as-is
                if (!path.startsWith('/')) {
                  path = '/' + path;
                }
              }

              // Only add LLM headers if this endpoint declares them
              if (endpointNeedsLLMHeaders(path)) {
                var settings = getLLMSettings();
                if (settings.baseUrl) {
                  request.headers["X-LLM-Base-Url"] = settings.baseUrl;
                }
                if (settings.apiKey) {
                  request.headers["X-LLM-Api-Key"] = settings.apiKey;
                }
                if (settings.modelId) {
                  request.headers["X-LLM-Model-Id"] = settings.modelId;
                }
                if (settings.maxTokens != null && settings.maxTokens !== '') {
                  request.headers["X-LLM-Max-Tokens"] = String(settings.maxTokens);
                }
                if (settings.temperature != null && settings.temperature !== '') {
                  request.headers["X-LLM-Temperature"] = String(settings.temperature);
                }
              }
              return request;
            },
          });
          window.ui = ui;
        });
      };
    </script>
  </body>
</html>
