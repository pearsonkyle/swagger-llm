<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="{{ swagger_css_url }}" />
    <style>
      body {
        margin: 0;
        background: #0f172a;
      }
      /* Keep the standard Swagger UI top bar */
      .swagger-ui .topbar {
        background: #111827;
      }
      /* Make the info section title more visible */
      .swagger-ui .info .title {
        color: #e5e7eb;
      }
    </style>
  </head>
  <body>
    <div id="swagger-ui"></div>

    <script src="{{ swagger_js_url }}"></script>
    <script src="{{ llm_settings_js_url }}"></script>
    <script src="{{ llm_layout_js_url }}"></script>

    <style>
      /* LLM Panel CSS - scoped to avoid conflicts */
      #llm-settings-panel {
        font-family: 'Inter', 'Segoe UI', sans-serif;
      }
      .llm-provider-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-right: 8px;
        color: #fff;
      }
      .llm-provider-openai { background-color: #10a37f; }
      .llm-provider-anthropic { background-color: #d97757; }
      .llm-provider-ollama { background-color: #2b90d8; }
      .llm-provider-vllm { background-color: #facc15; }
      .llm-provider-azure { background-color: #0078d4; }
    </style>

    <script>
      // LLM Provider configurations
      var LLM_PROVIDERS = {
        openai: { name: 'OpenAI', url: 'https://api.openai.com/v1' },
        anthropic: { name: 'Anthropic', url: 'https://api.anthropic.com/v1' },
        ollama: { name: 'Ollama', url: 'http://localhost:11434/v1' },
        lmstudio: { name: 'LM Studio', url: 'http://localhost:1234/v1' },
        vllm: { name: 'vLLM', url: 'http://localhost:8000/v1' },
        azure: { name: 'Azure OpenAI', url: 'https://YOUR_RESOURCE_NAME.openai.azure.com/openai/deployments/YOUR_DEPLOYMENT' },
        custom: { name: 'Custom', url: '' }
      };

      // Read LLM settings from localStorage (set by the LLMSettingsPanel)
      var STORAGE_KEY = "swagger-llm-settings";

      function getLLMSettings() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch (e) {
          return {};
        }
      }

      // Generate curl command from request
      function generateCurl(request) {
        var url = request.url;
        if (request.queryParams && Object.keys(request.queryParams).length > 0) {
          var queryParams = Object.entries(request.queryParams)
            .map(function ([key, value]) { return key + '=' + encodeURIComponent(value); })
            .join('&');
          url = url.split('?')[0] + '?' + queryParams;
        }

        var headers = request.headers || {};
        var body = request.body ? JSON.parse(request.body) : null;

        var curl = ['curl -X ' + request.method + ' \\\\' ];

        Object.entries(headers).forEach(function ([key, value]) {
          if (value !== undefined && key.toLowerCase() !== 'content-length') {
            curl.push('  -H "' + key + ': ' + value.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '" \\\\');
          }
        });

        if (body && Object.keys(body).length > 0) {
          curl.push('  -d \'' + JSON.stringify(body, null, 2) + '\' \\\\');
        }

        curl.push('  "' + url.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '"');
        return curl.join('\n');
      }

      // Python httpx code snippet generator
      function generatePythonCode(request, settings) {
        var url = request.url;
        if (request.queryParams && Object.keys(request.queryParams).length > 0) {
          var queryParams = Object.entries(request.queryParams)
            .map(function ([key, value]) { return key + '=' + encodeURIComponent(value); })
            .join('&');
          url = url.split('?')[0] + '?' + queryParams;
        }

        var headers = request.headers || {};
        var body = request.body ? JSON.parse(request.body) : null;

        var code = ['import httpx', ''];
        
        // Add LLM config
        code.push('# LLM Configuration');
        code.push('llm_base_url = "' + (settings.baseUrl || '') + '"');
        code.push('llm_api_key = "' + (settings.apiKey || 'None') + '"');
        code.push('llm_model_id = "' + (settings.modelId || 'gpt-4') + '"');
        code.push('');
        
        code.push('async with httpx.AsyncClient() as client:');
        code.push('    response = await client.' + request.method.toLowerCase() + '("');
        code.push('        "' + url.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '",');
        
        if (Object.keys(headers).length > 0) {
          code.push('        headers={');
          Object.entries(headers).forEach(function ([key, value], i) {
            if (value !== undefined && key.toLowerCase() !== 'content-length') {
              var comma = i < Object.keys(headers).length - 1 ? ',' : '';
              code.push('            "' + key + '": "' + value.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '"' + comma);
            }
          });
          code.push('        },');
        }

        if (body && Object.keys(body).length > 0) {
          code.push('        json=' + JSON.stringify(body, null, 6).replace(/\n/g, '\n            ') + ',');
        }

        code.push('    )');
        code.push('');
        code.push('print(response.status_code)');
        code.push('print(response.json())');

        return code.join('\n');
      }

      window.onload = function () {
        var ui = SwaggerUIBundle({
          url: "{{ openapi_url }}",
          dom_id: "#swagger-ui",
          presets: [SwaggerUIBundle.presets.apis, SwaggerUIBundle.SwaggerUIStandalonePreset],
          plugins: [
            SwaggerUIBundle.plugins.DownloadUrl,
            LLMSettingsPlugin,
            LLMLayoutPlugin,
          ],
          layout: "LLMDocsLayout",

          // Inject X-LLM-* headers into every request made from the docs page
          requestInterceptor: function (request) {
            var settings = getLLMSettings();
            if (settings.baseUrl) {
              request.headers["X-LLM-Base-Url"] = settings.baseUrl;
            }
            if (settings.apiKey) {
              request.headers["X-LLM-Api-Key"] = settings.apiKey;
            }
            if (settings.modelId) {
              request.headers["X-LLM-Model-Id"] = settings.modelId;
            }
            if (settings.maxTokens != null && settings.maxTokens !== '') {
              request.headers["X-LLM-Max-Tokens"] = String(settings.maxTokens);
            }
            if (settings.temperature != null && settings.temperature !== '') {
              request.headers["X-LLM-Temperature"] = String(settings.temperature);
            }
            return request;
          },
        });
        window.ui = ui;

        // Keyboard shortcut: Cmd/Ctrl+Shift+L to toggle LLM panel
        document.addEventListener('keydown', function (e) {
          if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'L') {
            e.preventDefault();
            var panel = document.getElementById('llm-settings-panel');
            if (panel) {
              var existingToggle = panel.querySelector('.llm-toggle-btn');
              if (existingToggle && typeof existingToggle.click === 'function') {
                existingToggle.click();
              }
            }
          }
        });
      };
    </script>
  </body>
</html>
